---
title: "Project2"
author: "JL"
date: "11/15/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(jsonlite)
library(tidyverse)
library(tidytext)
library(topicmodels)
library(SnowballC)
library(randomForest)
library(stringi)
library(gridExtra)
library(tidytext)
library(ggthemes)
library(tm)
library(reshape2)
```

```{r cars}
automotive <- jsonlite::stream_in(file("Project Data/reviews_Automotive_5.json"))%>% 
  mutate(name="automotive")

amazon_instant <- jsonlite::stream_in(file("Project Data/reviews_Amazon_Instant_Video_5.json"))%>% 
  mutate(name="amazon_instant")

# #apps_for_android <- jsonlite::stream_in(file("Project Data/reviews_Apps_for_Android_5.json"))
# 
# #baby <- jsonlite::stream_in(file("Project Data/reviews_Baby_5.json"))
# 
# #beauty <- jsonlite::stream_in(file("Project Data/reviews_Beauty_5.json"))
# 
# #books <- jsonlite::stream_in(file("Project Data/reviews_Books_5.json"))
# 
# #cds_vinyl <- jsonlite::stream_in(file("Project Data/reviews_CDs_and_Vinyl_5.json"))
# 
# #cell_phones_and_accessories<- jsonlite::stream_in(file("Project Data/reviews_Cell_Phones_and_Accessories_5.json"))
# 
# #clothing_shoes <- jsonlite::stream_in(file("Project Data/reviews_Clothing_Shoes_and_Jewelry_5.json"))

digital_music <- jsonlite::stream_in(file("Project Data/reviews_Digital_Music_5.json"))%>% 
  mutate(name="digital_music")

# #electronics <- jsonlite::stream_in(file("Project Data/reviews_Electronics_5.json"))
# 
# #grocery <- jsonlite::stream_in(file("Project Data/reviews_Grocery_and_Gourmet_Food_5.json"))
# 
# #health_and_personal <- jsonlite::stream_in(file("Project Data/reviews_Health_and_Personal_Care_5.json"))
# 
# #home_kitchen <- jsonlite::stream_in(file("Project Data/reviews_Home_and_Kitchen_5.json"))
# 
# #kindle_store <- jsonlite::stream_in(file("Project Data/reviews_Kindle_Store_5.json"))
# 
# #movies_and_tv <- jsonlite::stream_in(file("Project Data/reviews_Movies_and_TV_5.json"))

musical <- jsonlite::stream_in(file("Project Data/reviews_Musical_Instruments_5.json")) %>% 
  mutate(name="musical")

office_products <- jsonlite::stream_in(file("Project Data/reviews_Office_Products_5.json"))%>% 
  mutate(name="office_products")

patio_lawn <- jsonlite::stream_in(file("Project Data/reviews_Patio_Lawn_and_Garden_5.json"))%>% 
  mutate(name="patio_lawn")

pet <- jsonlite::stream_in(file("Project Data/reviews_Pet_Supplies_5.json"))%>% 
  mutate(name="pet")

# sports_outdoors <- jsonlite::stream_in(file("Project Data/reviews_Sports_and_Outdoors_5.json"))

tools <- jsonlite::stream_in(file("Project Data/reviews_Tools_and_Home_Improvement_5.json"))%>% 
  mutate(name="tools")

# toys_games <- jsonlite::stream_in(file("Project Data/reviews_Toys_and_Games_5.json"))
# 
# video_games<- jsonlite::stream_in(file("Project Data/reviews_Video_Games_5.json"))
# 
# df<-rbind(amazon_instant,apps_for_android, automotive, baby, cds_vinyl, cell_phones_and_accessories, clothing_shoes, digital_music, electronics, grocery, health_and_personal, home_kitchen, kindle_store, movies_and_tv, musical, office_products, patio_lawn, pet, sports_outdoors, tools, toys_games, video_games)

df<-rbind(amazon_instant,automotive,digital_music,musical,office_products,patio_lawn,pet,tools)
```

```{r}
deduped <- df[!duplicated(df$reviewText), ]
deduped$reviewTime <- as.POSIXct(deduped$reviewTime, format = "%m %d, %Y", tz = "EST")
deduped$reviewText<- as.character(deduped$reviewText)
deduped$id <- 1:nrow(deduped)
deduped$reviewTime <- as.POSIXct(deduped$reviewTime)
```

```{r}
df2 <- deduped%>% 
  mutate(reviewLength=stri_length(reviewText)) %>% 
  rename(Rating=overall) %>% 
  filter(reviewLength<6000) %>% 
  mutate(helpful_final = dplyr::combine(helpful)[c(T,F)],
         not_helpful_final =dplyr::combine(helpful)[c(F,T)] - dplyr::combine(helpful)[c(T,F)],
         perc_helpful_final =ifelse(helpful_final==0 , 0, 
         helpful_final / (helpful_final + not_helpful_final)), Rating_Scaled=Rating/5,               reviewLengthFactor=ifelse(reviewLength<200,"Short",ifelse(reviewLength<600,"Medium","Long"))) %>% 
  select(-helpful)
colnames(df2)
df2_sampled<-sample_n(df2,10000)
```


```{r}
# data(stop_words)
# deduped %>%
#   unnest_tokens(word, reviewText) %>%
#   anti_join(stop_words) %>%
#   mutate(word = wordStem(word)) %>%
#   count(word, sort = T) %>%
#   filter(n>3000) %>%
#   mutate(word = reorder(word, n)) %>%
#   ggplot(aes(word, n)) +
#   geom_col() +
#   xlab(NULL) +
#   coord_flip()
```

Distrubution and Visualization of the Variables

```{r}
##Tier 1: Rating
ggplot(df2_sampled,aes(x=Rating))+geom_bar(stat="count",aes(fill=as.factor(Rating)))+geom_text(stat='bin',aes(label=..count..),vjust=-1,binwidth=1)+ggtitle("Ratings Distribution")+theme(legend.position="none")
```
BREAKDOWN OF RATINGS 1-5 - ALMOST ALL 5
```{r}
#Ratings vs Helpful
ggplot(df2_sampled,aes(x=Rating,y=perc_helpful_final,group=Rating))+geom_boxplot()+scale_y_continuous(limits = c(0.00001,1))+ggtitle("Percent of votes as 'Helpful' vs Rating")+ylab("% of Votes as 'Helpful'")
```
BOXPLOT OF RATING VS % OF VOTES = HELPFUL - WHEN RATING GOES TO 5, THE % OF VOTES = HELPFUL APPROACHES 100%.  WE HAD TO REMOVE THE 0% HELPFUL BECAUSE IT MESSED UP THE SCALE AS MOST HAVE 0/0
```{r}
#Ratings vs ReviewLength
ggplot(df2_sampled,aes(x=Rating,fill=reviewLengthFactor))+geom_bar(stat="count")+ggtitle("Rating Distriubtion based on Review Length")
```
3 TONED BOXPLOT OF REVIEWLENGTHFACTOR - LONG MEDIUM AND SHORT ARE EVENLY DISTRIBUTED ACROSS RATING

```{r}
##Tier 1: ReviewLength
ggplot(df2_sampled,aes(x=reviewLength,fill="red"))+geom_density()+scale_x_continuous(limits = c(0,1000))+theme_classic()+theme(legend.position="none")+ggtitle("Distribution of ReviewLength")#Values more than 1000 continued the trend
```

#ReviewLength vs Helpful
ggplot(filter(df2_sampled,helpful_final<100), aes(x=reviewLength, y=helpful_final))+geom_point()+stat_smooth()+ylab("Helpful Votes")+ggtitle("ReviewLength vs # of Helpful Votes")


```{r}
##Tier 2: Prolific Reviewers
df2b<-sample_n(df2,100000)
prolific_users<-df2b %>% 
  group_by(reviewerID) %>% 
  summarise(reviews=n(),meanRating=mean(Rating),meanLength=mean(reviewLength),popularity=sum(helpful_final)-sum(not_helpful_final))
#NumReviews vs MeanRating
ggplot(filter(prolific_users,reviews<30),aes(x=reviews,meanRating))+geom_point()+stat_smooth()+ggtitle("Mean Rating (per user) vs num Reviews (per user)")
#NumReviews vs MeanLength
ggplot(filter(prolific_users,meanLength<8000 & reviews<60),aes(x=reviews,meanLength))+geom_point()+stat_smooth()+ggtitle("Mean Review Length (per user) vs num Reviews (per user)")
#NumReviews vs Helpful
ggplot(filter(prolific_users,popularity<1000 & reviews<45),aes(x=reviews,popularity))+geom_point()+stat_smooth()+ggtitle("Mean Review Length (per user) vs Popularity (per user)")

##Tier 2: Prolific Products
prolific_products<-df2b %>% 
  group_by(asin) %>% 
  summarise(reviews=n(),meanRating=mean(Rating),meanLength=mean(reviewLength),avg_popularity=mean(perc_helpful_final))
#NumReviews vs MeanRating
ggplot(filter(prolific_products,reviews<30),aes(x=reviews,meanRating))+geom_point()+stat_smooth()+ggtitle("Mean Rating (per product) vs num Reviews (per product)")
#NumReviews vs MeanLength
ggplot(filter(prolific_products,meanLength<8000 & reviews<60),aes(x=reviews,meanLength))+geom_point()+stat_smooth()+ggtitle("Mean Review Length (per product) vs num Reviews (per product)")
#NumReviews vs Helpful
ggplot(filter(prolific_products,reviews<45),aes(x=reviews,y=avg_popularity))+geom_point()+stat_smooth()+ggtitle("Mean Review Length (per product) vs Avg Helpfulness (per product)")
```

Text Analysis for Groups
```{r}
temp <- df2_sampled %>%
  unnest_tokens(word, reviewText) %>%
  anti_join(stop_words) %>%
  mutate(word = wordStem(word)) %>%
  count(word, sort = T)

final <- df2_sampled %>%
  unnest_tokens(word, reviewText) %>%
  anti_join(stop_words) %>%
  mutate(word = wordStem(word)) %>%
  left_join(temp, on = "word") %>%
  bind_tf_idf(word, id, n)

final %>%
  arrange(desc(tf_idf)) %>%
  mutate(word = factor(word, levels = rev(unique(word))))%>%
  top_n(20) %>%
  ggplot(aes(word, tf_idf)) +
  geom_col() +
  labs(x = NULL, y = "tf-idf") +
  coord_flip()
```

```{r}
mat_final <- final %>%
  cast_dtm(id, word, n)

ap_lda <- LDA(mat_final, k = 8, control = list(seed = 1234))

ap_lda
str(ap_lda)
ap_topics <- tidy(ap_lda, matrix = "beta")

ap_top_terms <- ap_topics %>%
  group_by(topic) %>%
  top_n(10, beta) %>%
  ungroup() %>%
  arrange(topic, -beta)

print("Categories grouped on: Amazon Instant Video, Automotive, Digital Music, Musical Instruments, Office Products, Patio/Lawn, Pets, and Tools")

a<-ap_top_terms %>%
  mutate(term = reorder(term, beta)) %>%
  ggplot(aes(term, beta, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  coord_flip()+ggtitle("Text Groups")
a
beta_spread <- ap_topics %>%
  mutate(topic = paste0("topic", topic)) %>%
  spread(topic, beta) %>%
  filter(topic1 > .001 | topic2 > .001) %>%
  mutate(log_ratio = log2(topic2 / topic1))

beta_spread
```

```{r}
train<-sample_n(df2,100000)
test<-anti_join(df2,train)
formula<-"Rating~helpful_final+reviewLength+name+not_helpful_final"
mod<-lm(formula,data=train)
summary(mod)

test$prediction<-(predict(mod,test))
error<-test$Rating-test$prediction
mse<-sqrt(mean(error^2))
mse

ggplot(test,aes(prediction))+geom_density(stat="count")+scale_x_continuous(limits = c(4,5))
```

