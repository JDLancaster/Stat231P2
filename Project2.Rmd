---
title: "Project2"
author: "JL"
date: "11/15/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(jsonlite)
library(tidyverse)
library(tidytext)
library(topicmodels)
library(SnowballC)
library(randomForest)
```

```{r cars}
data<-lapply(readLines("reviews_Musical_Instruments_5.json"), fromJSON, flatten = TRUE)
df <- plyr::ldply(data, data.frame)
```

```{r}
deduped <- df[!duplicated(df$reviewText), ]
deduped$reviewTime <- as.POSIXct(deduped$reviewTime, format = "%m %d, %Y", tz = "EST")
deduped$reviewText<- as.character(deduped$reviewText)
deduped$id <- 1:nrow(deduped)
#deduped$reviewTime <- as.POSIXct(deduped$reviewTime)
```

```{r}
data(stop_words)
deduped %>%
  unnest_tokens(word, reviewText) %>%
  anti_join(stop_words) %>%
  mutate(word = wordStem(word)) %>%
  count(word, sort = T) %>%
  filter(n>1200) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n)) + 
  geom_col() +
  xlab(NULL) +
  coord_flip()
```

```{r}

temp <- deduped %>%
  unnest_tokens(word, reviewText) %>%
  anti_join(stop_words) %>%
  mutate(word = wordStem(word)) %>%
  count(word, sort = T)

final <- deduped %>%
  unnest_tokens(word, reviewText) %>%
  anti_join(stop_words) %>%
  mutate(word = wordStem(word)) %>%
  left_join(temp, on = "word") %>%
  bind_tf_idf(word, id, n)

final %>%
  arrange(desc(tf_idf)) %>%
  mutate(word = factor(word, levels = rev(unique(word))))%>% 
  top_n(20) %>%
  ggplot(aes(word, tf_idf)) +
  geom_col() +
  labs(x = NULL, y = "tf-idf") +
  coord_flip()
```

```{r}
mat_final <- final %>%
  cast_dtm(id, word, n)

ap_lda <- LDA(mat_final, k = 3, control = list(seed = 1234))
ap_lda
ap_topics <- tidy(ap_lda, matrix = "beta")

ap_top_terms <- ap_topics %>%
  group_by(topic) %>%
  top_n(10, beta) %>%
  ungroup() %>%
  arrange(topic, -beta)

ap_top_terms %>%
  mutate(term = reorder(term, beta)) %>%
  ggplot(aes(term, beta, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  coord_flip()

beta_spread <- ap_topics %>%
  mutate(topic = paste0("topic", topic)) %>%
  spread(topic, beta) %>%
  filter(topic1 > .001 | topic2 > .001) %>%
  mutate(log_ratio = log2(topic2 / topic1))

beta_spread
```

```{r}
##plot_austen %>% 
# group_by(book) %>% 
#  top_n(15) %>% 
#  ungroup %>%
#  ggplot(aes(word, tf_idf, fill = book)) +
#  geom_col(show.legend = FALSE) +
#  labs(x = NULL, y = "tf-idf") +
#  facet_wrap(~book, ncol = 2, scales = "free") +
#  coord_flip()
```




